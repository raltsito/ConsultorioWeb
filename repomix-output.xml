This file is a merged representation of a subset of the codebase, containing files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching these patterns are excluded: **/node_modules/**, **/venv/**, **/.git/**, **/__pycache__/**, **/build/**, **/dist/**, **/*.sqlite3
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
analisis_datos.py
cargar_pacientes.py
clinica/__init__.py
clinica/admin.py
clinica/apps.py
clinica/forms.py
clinica/management/commands/__init__.py
clinica/management/commands/cargar_datos.py
clinica/migrations/__init__.py
clinica/migrations/0001_initial.py
clinica/migrations/0002_paciente_sexo.py
clinica/migrations/0003_paciente_nombre_normalizado.py
clinica/migrations/0004_sede_alter_cita_options_rename_hora_cita_hora_fin_and_more.py
clinica/migrations/0005_documentopaciente_expedientemedico_delete_division_and_more.py
clinica/models.py
clinica/static/clinica/images/logo.png
clinica/templates/clinica/agendar_cita.html
clinica/templates/clinica/calendario.html
clinica/templates/clinica/detalle_paciente.html
clinica/templates/clinica/editar_paciente.html
clinica/templates/clinica/home.html
clinica/templates/clinica/lista_pacientes.html
clinica/templates/clinica/registro_paciente.html
clinica/templates/registration/login.html
clinica/tests.py
clinica/utils.py
clinica/views.py
configuracion.json
core/__init__.py
core/asgi.py
core/settings.py
core/urls.py
core/wsgi.py
credenciales_google.json
datos_originales.xlsx
Docs/~$cumento de Requerimientos.docx
Docs/Documento de Requerimientos.docx
limpiar_pacientes.py
logointra.jpg
manage.py
media/documentos/Gemini_Generated_Image_x0z95ax0z95ax0z9_zwQWBd6.png
media/documentos/Gemini_Generated_Image_x0z95ax0z95ax0z9.png
PACIENTES_LIMPIOS.xlsx
passenger_wsgi.py
proyecto_web.zip
requirements.txt
REVISAR_PACIENTES.xlsx
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="clinica/migrations/0004_sede_alter_cita_options_rename_hora_cita_hora_fin_and_more.py">
# Generated by Django 5.2.10 on 2026-02-11 17:45

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('clinica', '0003_paciente_nombre_normalizado'),
    ]

    operations = [
        migrations.CreateModel(
            name='Sede',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=100)),
                ('direccion', models.CharField(blank=True, max_length=255, null=True)),
            ],
        ),
        migrations.AlterModelOptions(
            name='cita',
            options={'ordering': ['-fecha', '-hora_inicio']},
        ),
        migrations.RenameField(
            model_name='cita',
            old_name='hora',
            new_name='hora_fin',
        ),
        migrations.RemoveField(
            model_name='cita',
            name='division',
        ),
        migrations.RemoveField(
            model_name='cita',
            name='estatus',
        ),
        migrations.RemoveField(
            model_name='cita',
            name='folio_fiscal',
        ),
        migrations.RemoveField(
            model_name='cita',
            name='metodo_pago',
        ),
        migrations.AddField(
            model_name='cita',
            name='actualizado_en',
            field=models.DateTimeField(auto_now=True),
        ),
        migrations.AddField(
            model_name='cita',
            name='creado_en',
            field=models.DateTimeField(auto_now_add=True, default=django.utils.timezone.now),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='cita',
            name='estado',
            field=models.CharField(choices=[('pendiente', 'Pendiente'), ('confirmada', 'Confirmada'), ('realizada', 'Realizada'), ('cancelada', 'Cancelada'), ('no_asistio', 'No Asisti√≥')], default='pendiente', max_length=20),
        ),
        migrations.AddField(
            model_name='cita',
            name='hora_inicio',
            field=models.TimeField(default='09:00'),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name='cita',
            name='pagado',
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name='consultorio',
            name='activo',
            field=models.BooleanField(default=True),
        ),
        migrations.AlterField(
            model_name='cita',
            name='consultorio',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='clinica.consultorio'),
        ),
        migrations.AlterField(
            model_name='cita',
            name='costo',
            field=models.DecimalField(decimal_places=2, default=0.0, max_digits=10),
        ),
        migrations.AlterField(
            model_name='cita',
            name='terapeuta',
            field=models.ForeignKey(default=1, on_delete=django.db.models.deletion.CASCADE, related_name='agenda', to='clinica.terapeuta'),
            preserve_default=False,
        ),
        migrations.AlterField(
            model_name='consultorio',
            name='nombre',
            field=models.CharField(max_length=50),
        ),
        migrations.AddField(
            model_name='consultorio',
            name='sede',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='consultorios', to='clinica.sede'),
        ),
    ]
</file>

<file path="clinica/migrations/0005_documentopaciente_expedientemedico_delete_division_and_more.py">
# Generated by Django 5.2.10 on 2026-02-12 16:14

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('clinica', '0004_sede_alter_cita_options_rename_hora_cita_hora_fin_and_more'),
    ]

    operations = [
        migrations.CreateModel(
            name='DocumentoPaciente',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('tipo', models.CharField(choices=[('receta', 'Receta M√©dica'), ('estudio', 'Estudio/An√°lisis'), ('radiografia', 'Radiograf√≠a'), ('consentimiento', 'Consentimiento Informado'), ('otro', 'Otro')], max_length=20)),
                ('titulo', models.CharField(max_length=200)),
                ('descripcion', models.TextField(blank=True, null=True)),
                ('archivo', models.FileField(upload_to='documentos/')),
                ('fecha_documento', models.DateField()),
                ('subido_en', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'verbose_name': 'Documento',
                'verbose_name_plural': 'Documentos',
                'ordering': ['-fecha_documento'],
            },
        ),
        migrations.CreateModel(
            name='ExpedienteMedico',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('alergias', models.TextField(blank=True, null=True)),
                ('enfermedades_cronicas', models.TextField(blank=True, null=True)),
                ('medicamentos_actuales', models.TextField(blank=True, null=True)),
                ('cirugias_previas', models.TextField(blank=True, null=True)),
                ('antecedentes_familiares', models.TextField(blank=True, null=True)),
                ('tipo_sangre', models.CharField(blank=True, max_length=5, null=True)),
                ('peso', models.DecimalField(blank=True, decimal_places=2, help_text='Peso en kg', max_digits=5, null=True)),
                ('altura', models.DecimalField(blank=True, decimal_places=2, help_text='Altura en cm', max_digits=5, null=True)),
                ('creado_en', models.DateTimeField(auto_now_add=True)),
                ('actualizado_en', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Expediente M√©dico',
                'verbose_name_plural': 'Expedientes M√©dicos',
            },
        ),
        migrations.DeleteModel(
            name='Division',
        ),
        migrations.RemoveField(
            model_name='cita',
            name='servicio',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='servicio_inicial',
        ),
        migrations.AlterModelOptions(
            name='cita',
            options={'ordering': ['-fecha', '-hora_inicio'], 'verbose_name': 'Cita', 'verbose_name_plural': 'Citas'},
        ),
        migrations.AlterModelOptions(
            name='consultorio',
            options={'ordering': ['sede__nombre', 'nombre'], 'verbose_name': 'Consultorio', 'verbose_name_plural': 'Consultorios'},
        ),
        migrations.AlterModelOptions(
            name='paciente',
            options={'ordering': ['nombre'], 'verbose_name': 'Paciente', 'verbose_name_plural': 'Pacientes'},
        ),
        migrations.AlterModelOptions(
            name='sede',
            options={'ordering': ['nombre'], 'verbose_name': 'Sede', 'verbose_name_plural': 'Sedes'},
        ),
        migrations.AlterModelOptions(
            name='terapeuta',
            options={'ordering': ['nombre'], 'verbose_name': 'Terapeuta', 'verbose_name_plural': 'Terapeutas'},
        ),
        migrations.RenameField(
            model_name='cita',
            old_name='notas',
            new_name='notas_pago',
        ),
        migrations.RenameField(
            model_name='paciente',
            old_name='fecha_registro',
            new_name='creado_en',
        ),
        migrations.RenameField(
            model_name='paciente',
            old_name='resumen_clinico',
            new_name='direccion',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='apertura_expediente',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='consentimiento_firmado',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='enlace_resultados',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='estudio_socioeconomico',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='identidad_contacto',
        ),
        migrations.RemoveField(
            model_name='paciente',
            name='pacientes_relacionados',
        ),
        migrations.AddField(
            model_name='cita',
            name='metodo_pago',
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AddField(
            model_name='cita',
            name='motivo',
            field=models.CharField(blank=True, max_length=200, null=True),
        ),
        migrations.AddField(
            model_name='cita',
            name='observaciones',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='consultorio',
            name='capacidad',
            field=models.IntegerField(default=1, help_text='N√∫mero de personas que puede atender simult√°neamente'),
        ),
        migrations.AddField(
            model_name='paciente',
            name='activo',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='paciente',
            name='actualizado_en',
            field=models.DateTimeField(auto_now=True),
        ),
        migrations.AddField(
            model_name='paciente',
            name='contacto_emergencia',
            field=models.CharField(blank=True, max_length=200, null=True),
        ),
        migrations.AddField(
            model_name='paciente',
            name='email',
            field=models.EmailField(blank=True, max_length=254, null=True),
        ),
        migrations.AddField(
            model_name='paciente',
            name='notas',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='paciente',
            name='telefono_emergencia',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AddField(
            model_name='sede',
            name='activo',
            field=models.BooleanField(default=True),
        ),
        migrations.AddField(
            model_name='sede',
            name='telefono',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AddField(
            model_name='terapeuta',
            name='color_calendario',
            field=models.CharField(default='#3788d8', help_text='Color en formato hexadecimal para el calendario', max_length=7),
        ),
        migrations.AddField(
            model_name='terapeuta',
            name='email',
            field=models.EmailField(blank=True, max_length=254, null=True),
        ),
        migrations.AddField(
            model_name='terapeuta',
            name='especialidad',
            field=models.CharField(blank=True, max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='terapeuta',
            name='telefono',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AlterField(
            model_name='paciente',
            name='fecha_nacimiento',
            field=models.DateField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='paciente',
            name='nombre',
            field=models.CharField(max_length=200),
        ),
        migrations.AlterField(
            model_name='paciente',
            name='sexo',
            field=models.CharField(blank=True, choices=[('M', 'Masculino'), ('F', 'Femenino'), ('O', 'Otro')], max_length=1, null=True),
        ),
        migrations.AlterField(
            model_name='paciente',
            name='telefono',
            field=models.CharField(blank=True, max_length=20, null=True),
        ),
        migrations.AlterField(
            model_name='terapeuta',
            name='nombre',
            field=models.CharField(max_length=200),
        ),
        migrations.AddIndex(
            model_name='cita',
            index=models.Index(fields=['fecha', 'terapeuta'], name='clinica_cit_fecha_f70556_idx'),
        ),
        migrations.AddIndex(
            model_name='cita',
            index=models.Index(fields=['paciente', 'fecha'], name='clinica_cit_pacient_bf01cc_idx'),
        ),
        migrations.AddIndex(
            model_name='cita',
            index=models.Index(fields=['estado'], name='clinica_cit_estado_83390f_idx'),
        ),
        migrations.AddIndex(
            model_name='paciente',
            index=models.Index(fields=['nombre_normalizado'], name='clinica_pac_nombre__e2ad02_idx'),
        ),
        migrations.AddIndex(
            model_name='paciente',
            index=models.Index(fields=['telefono'], name='clinica_pac_telefon_378ffd_idx'),
        ),
        migrations.AddField(
            model_name='documentopaciente',
            name='paciente',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documentos', to='clinica.paciente'),
        ),
        migrations.AddField(
            model_name='expedientemedico',
            name='paciente',
            field=models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='expediente', to='clinica.paciente'),
        ),
        migrations.DeleteModel(
            name='Servicio',
        ),
    ]
</file>

<file path="clinica/templates/clinica/calendario.html">
{% extends 'clinica/home.html' %}
{% load static %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<style>
    .fc-event {
        cursor: pointer;
    }
    .modal-body .info-row {
        margin-bottom: 1rem;
    }
    .modal-body .info-label {
        font-weight: bold;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    .modal-body .info-value {
        color: #212529;
    }
    .badge-estado {
        font-size: 0.9rem;
        padding: 0.35em 0.65em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">
            <i class="bi bi-calendar3"></i> Agenda General
        </h2>
        <div class="btn-group">
            <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#modalNuevaCita">
                <i class="bi bi-plus-lg"></i> Nueva Cita
            </button>
            <button class="btn btn-outline-secondary" id="btnHoy">
                <i class="bi bi-calendar-day"></i> Hoy
            </button>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filtroTerapeuta" class="form-label">Filtrar por Terapeuta:</label>
                    <select id="filtroTerapeuta" class="form-select">
                        <option value="">Todos los terapeutas</option>
                        {% for terapeuta in terapeutas %}
                        <option value="{{ terapeuta.id }}">{{ terapeuta.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Calendario -->
    <div class="card shadow border-0 p-3" style="background: white;">
        <div id='calendar'></div>
    </div>
</div>

<!-- Modal para Nueva Cita -->
<div class="modal fade" id="modalNuevaCita" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-plus"></i> Agendar Nueva Cita
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'crear_cita' %}" id="formNuevaCita">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="erroresForm" class="alert alert-danger d-none"></div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ form.paciente.label_tag }}
                            {{ form.paciente }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.terapeuta.label_tag }}
                            {{ form.terapeuta }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.fecha.label_tag }}
                            {{ form.fecha }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.hora_inicio.label_tag }}
                            {{ form.hora_inicio }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.duracion_minutos.label_tag }}
                            {{ form.duracion_minutos }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.consultorio.label_tag }}
                            {{ form.consultorio }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-12">
                            {{ form.motivo.label_tag }}
                            {{ form.motivo }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6">
                            {{ form.costo.label_tag }}
                            {{ form.costo }}
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-12">
                            {{ form.observaciones.label_tag }}
                            {{ form.observaciones }}
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> Agendar Cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalles de Cita -->
<div class="modal fade" id="modalDetalleCita" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i> Detalles de la Cita
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenidoDetalleCita">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="accionesDetalleCita">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/es.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const filtroTerapeuta = document.getElementById('filtroTerapeuta');
    
    // Inicializar calendario
    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: 'es',
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        buttonText: {
            today: 'Hoy',
            month: 'Mes',
            week: 'Semana',
            day: 'D√≠a',
            list: 'Lista'
        },
        slotMinTime: '08:00:00',
        slotMaxTime: '20:00:00',
        allDaySlot: false,
        height: 'auto',
        eventClick: function(info) {
            mostrarDetalleCita(info.event.id);
        },
        events: function(info, successCallback, failureCallback) {
            const terapeutaId = filtroTerapeuta.value;
            const url = new URL('{% url "calendario_citas" %}', window.location.origin);
            
            url.searchParams.append('start', info.startStr);
            url.searchParams.append('end', info.endStr);
            if (terapeutaId) {
                url.searchParams.append('terapeuta', terapeutaId);
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => successCallback(data))
                .catch(error => {
                    console.error('Error al cargar citas:', error);
                    failureCallback(error);
                });
        },
        eventDidMount: function(info) {
            // Tooltip con informaci√≥n b√°sica
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip bs-tooltip-top';
            tooltip.innerHTML = `
                <div class="tooltip-arrow"></div>
                <div class="tooltip-inner">
                    ${info.event.extendedProps.paciente}<br>
                    ${info.event.extendedProps.estado_display}
                </div>
            `;
            info.el.setAttribute('title', info.event.title);
        }
    });
    
    calendar.render();
    
    // Bot√≥n "Hoy"
    document.getElementById('btnHoy').addEventListener('click', function() {
        calendar.today();
    });
    
    // Filtro de terapeuta
    filtroTerapeuta.addEventListener('change', function() {
        calendar.refetchEvents();
    });
    
    // Env√≠o del formulario de nueva cita (AJAX)
    document.getElementById('formNuevaCita').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const erroresDiv = document.getElementById('erroresForm');
        
        // Limpiar errores previos
        erroresDiv.classList.add('d-none');
        erroresDiv.innerHTML = '';
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        
        fetch('{% url "crear_cita" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaCita'));
                modal.hide();
                
                // Limpiar formulario
                document.getElementById('formNuevaCita').reset();
                
                // Recargar eventos del calendario
                calendar.refetchEvents();
                
                // Mostrar mensaje de √©xito
                mostrarNotificacion('success', data.message);
            } else {
                // Mostrar errores
                if (data.errors) {
                    for (let field in data.errors) {
                        const input = document.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.classList.add('is-invalid');
                            const feedback = input.nextElementSibling;
                            if (feedback && feedback.classList.contains('invalid-feedback')) {
                                feedback.textContent = data.errors[field].join(', ');
                            }
                        }
                    }
                }
                erroresDiv.classList.remove('d-none');
                erroresDiv.innerHTML = data.message || 'Error al crear la cita';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            erroresDiv.classList.remove('d-none');
            erroresDiv.innerHTML = 'Error de conexi√≥n al crear la cita';
        });
    });
    
    // Funci√≥n para mostrar detalles de la cita
    function mostrarDetalleCita(citaId) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalleCita'));
        const contenido = document.getElementById('contenidoDetalleCita');
        const acciones = document.getElementById('accionesDetalleCita');
        
        // Mostrar loading
        contenido.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        `;
        
        modal.show();
        
        // Cargar detalles
        fetch(`/citas/${citaId}/detalle/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const cita = data.cita;
                    
                    // Determinar badge de estado
                    const estadoBadges = {
                        'pendiente': 'warning',
                        'confirmada': 'info',
                        'realizada': 'success',
                        'cancelada': 'danger',
                        'no_asistio': 'secondary'
                    };
                    const badgeColor = estadoBadges[cita.estado] || 'secondary';
                    
                    contenido.innerHTML = `
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-row">
                                    <div class="info-label">Paciente:</div>
                                    <div class="info-value">
                                        <a href="/pacientes/${cita.paciente.id}/" class="text-decoration-none">
                                            <i class="bi bi-person-circle"></i> ${cita.paciente.nombre}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <div class="info-label">Estado:</div>
                                    <div class="info-value">
                                        <span class="badge bg-${badgeColor} badge-estado">
                                            ${cita.estado_display}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <div class="info-label">Terapeuta:</div>
                                    <div class="info-value">${cita.terapeuta || 'No asignado'}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <div class="info-label">Consultorio:</div>
                                    <div class="info-value">${cita.consultorio || 'No asignado'}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-row">
                                    <div class="info-label">Fecha:</div>
                                    <div class="info-value">${formatearFecha(cita.fecha)}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-row">
                                    <div class="info-label">Hora:</div>
                                    <div class="info-value">${cita.hora_inicio} - ${cita.hora_fin}</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-row">
                                    <div class="info-label">Duraci√≥n:</div>
                                    <div class="info-value">${cita.duracion} minutos</div>
                                </div>
                            </div>
                            ${cita.motivo ? `
                            <div class="col-md-12">
                                <div class="info-row">
                                    <div class="info-label">Motivo:</div>
                                    <div class="info-value">${cita.motivo}</div>
                                </div>
                            </div>
                            ` : ''}
                            ${cita.observaciones ? `
                            <div class="col-md-12">
                                <div class="info-row">
                                    <div class="info-label">Observaciones:</div>
                                    <div class="info-value">${cita.observaciones}</div>
                                </div>
                            </div>
                            ` : ''}
                            <div class="col-md-6">
                                <div class="info-row">
                                    <div class="info-label">Costo:</div>
                                    <div class="info-value">$${cita.costo.toFixed(2)}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-row">
                                    <div class="info-label">Estado de Pago:</div>
                                    <div class="info-value">
                                        ${cita.pagado ? 
                                            '<span class="badge bg-success">‚úì Pagado</span>' : 
                                            '<span class="badge bg-warning">‚úó Pendiente</span>'
                                        }
                                    </div>
                                </div>
                            </div>
                            ${cita.paciente.telefono ? `
                            <div class="col-md-12">
                                <div class="info-row">
                                    <div class="info-label">Tel√©fono del paciente:</div>
                                    <div class="info-value">
                                        <a href="tel:${cita.paciente.telefono}" class="text-decoration-none">
                                            <i class="bi bi-telephone"></i> ${cita.paciente.telefono}
                                        </a>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Actualizar acciones
                    acciones.innerHTML = `
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <a href="/citas/${citaId}/editar/" class="btn btn-warning">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <a href="/pacientes/${cita.paciente.id}/" class="btn btn-primary">
                            <i class="bi bi-person"></i> Ver Paciente
                        </a>
                    `;
                } else {
                    contenido.innerHTML = `
                        <div class="alert alert-danger">
                            ${data.message || 'Error al cargar los detalles'}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                contenido.innerHTML = `
                    <div class="alert alert-danger">
                        Error de conexi√≥n al cargar los detalles
                    </div>
                `;
            });
    }
    
    // Funci√≥n auxiliar para formatear fecha
    function formatearFecha(fechaStr) {
        const fecha = new Date(fechaStr + 'T00:00:00');
        const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
        return fecha.toLocaleDateString('es-MX', opciones);
    }
    
    // Funci√≥n para mostrar notificaciones
    function mostrarNotificacion(tipo, mensaje) {
        // Implementar sistema de notificaciones toast o similar
        alert(mensaje);
    }
});
</script>
{% endblock %}
</file>

<file path="analisis_datos.py">
import pandas as pd
import os

def analizar_excel():
    print(" Leyendo archivo Excel...")
    
    try:
        # 1. Cargamos el Excel
        df = pd.read_excel('datos_originales.xlsx', sheet_name='Datos')
        
        # 2. TRUCO DE MAGIA: Quitamos espacios vac√≠os en los t√≠tulos de las columnas
        # (As√≠ "Paciente " se convierte en "Paciente")
        df.columns = df.columns.str.strip()
        
        print("\n Las columnas que encontr√© en tu Excel son:")
        print(df.columns.tolist())
        print("-" * 30)

        # 3. Verificamos si existe la columna, o tratamos de adivinar
        columna_nombre = 'Paciente|text-1'
        
        if columna_nombre not in df.columns:
            print(f" ERROR: No encuentro la columna '{columna_nombre}'.")
            print(" Revisa la lista de arriba y cambia la variable 'columna_nombre' en este script.")
            # Intentamos buscar si hay alguna parecida
            posibles = [c for c in df.columns if 'paciente' in c.lower() or 'nombre' in c.lower()]
            if posibles:
                print(f"üí° ¬øQuiz√°s quisiste decir: '{posibles[0]}'?\n")
            return

        # 4. Si llegamos aqu√≠, ¬°la columna existe! Procedemos.
        print(f" Columna '{columna_nombre}' encontrada. Analizando...")
        
        df['Paciente_Limpio'] = df[columna_nombre].astype(str).str.strip().str.title()

        conteo = df['Paciente_Limpio'].value_counts().reset_index()
        conteo.columns = ['Nombre_Paciente', 'Total_Citas']
        conteo = conteo.sort_values(by='Nombre_Paciente')

        print(f" Se encontraron {len(conteo)} pacientes √∫nicos.")
        
        conteo.to_excel("REVISAR_PACIENTES.xlsx", index=False)
        print(" ¬°LISTO! Archivo 'REVISAR_PACIENTES.xlsx' creado.")

    except Exception as e:
        print(f" Error cr√≠tico: {e}")

if __name__ == "__main__":
    analizar_excel()
</file>

<file path="cargar_pacientes.py">
import os
import django
import pandas as pd
from datetime import date # <--- IMPORTANTE: Agregamos esto para manejar fechas

# --- CONFIGURACI√ìN DE DJANGO ---
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings') 
django.setup()

from clinica.models import Paciente

def cargar_datos():
    print("üöÄ Iniciando carga masiva de pacientes...")
    
    archivo = 'PACIENTES_LIMPIOS.csv'
    
    try:
        df = pd.read_csv(archivo)
    except:
        try:
            df = pd.read_excel('PACIENTES_LIMPIOS.xlsx')
        except:
            print("‚ùå ERROR: No encuentro el archivo 'PACIENTES_LIMPIOS.csv' ni '.xlsx'")
            return

    col_nombre = 'Nombre_Paciente'
    if col_nombre not in df.columns:
        col_nombre = df.columns[0]

    count_nuevos = 0
    count_existentes = 0

    print(f"üìÇ Procesando {len(df)} registros...")

    for index, row in df.iterrows():
        nombre_limpio = str(row[col_nombre]).strip()
        
        if not nombre_limpio or nombre_limpio.lower() == 'nan':
            continue

        # BUSCAR O CREAR
        obj, created = Paciente.objects.get_or_create(
            nombre=nombre_limpio,
            defaults={
                'telefono': '',
                'resumen_clinico': 'Importado desde Historial Excel',
                # üëá AQU√ç EST√Å EL TRUCO: Le damos una fecha falsa por defecto
                'fecha_nacimiento': date(2000, 1, 1), 
                'sexo': 'Femenino' # Ponemos uno por defecto, luego se corrige
            }
        )

        if created:
            print(f"   ‚ú® Creado: {nombre_limpio}")
            count_nuevos += 1
        else:
            print(f"   ‚ö†Ô∏è Ya exist√≠a: {nombre_limpio}")
            count_existentes += 1

    print("-" * 30)
    print(f"üéâ ¬°TERMINADO!")
    print(f"‚úÖ Pacientes Nuevos insertados: {count_nuevos}")
    print(f"‚è≠Ô∏è Pacientes que ya exist√≠an: {count_existentes}")
    print(f"üìä Total en base de datos: {Paciente.objects.count()}")

if __name__ == "__main__":
    cargar_datos()
</file>

<file path="clinica/__init__.py">

</file>

<file path="clinica/admin.py">
from django.contrib import admin
from .models import Paciente, Cita, Terapeuta, Consultorio, Division, Servicio


admin.site.register(Terapeuta)
admin.site.register(Consultorio)
admin.site.register(Division)
admin.site.register(Servicio)

class PacienteAdmin(admin.ModelAdmin):
    list_display = ('nombre', 'telefono', 'servicio_inicial', 'fecha_registro')
    search_fields = ('nombre',)

class CitaAdmin(admin.ModelAdmin):
    list_display = ('paciente', 'fecha', 'hora', 'terapeuta', 'estatus')
    list_filter = ('fecha', 'estatus', 'terapeuta', 'consultorio')

admin.site.register(Paciente, PacienteAdmin)
admin.site.register(Cita, CitaAdmin)
</file>

<file path="clinica/apps.py">
from django.apps import AppConfig


class ClinicaConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'clinica'
</file>

<file path="clinica/forms.py">
from django import forms
from .models import Paciente, Cita

class PacienteForm(forms.ModelForm):
    class Meta:
        model = Paciente
        fields = [
            'nombre', 'fecha_nacimiento', 'telefono', 'identidad_contacto', 
            'servicio_inicial','pacientes_relacionados', 'consentimiento_firmado', 'estudio_socioeconomico', 
            'apertura_expediente', 'resumen_clinico', 'enlace_resultados'
        ]
        widgets = {
            'nombre': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Nombre completo'}),
            'fecha_nacimiento': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'telefono': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'WhatsApp'}),
            'identidad_contacto': forms.Select(attrs={'class': 'form-select'}),
            'servicio_inicial': forms.Select(attrs={'class': 'form-select'}),
            
            'consentimiento_firmado': forms.FileInput(attrs={'class': 'form-control'}),
            'estudio_socioeconomico': forms.FileInput(attrs={'class': 'form-control'}),
            'apertura_expediente': forms.FileInput(attrs={'class': 'form-control'}),
            'resumen_clinico': forms.Textarea(attrs={'class': 'form-control', 'rows': 4, 'placeholder': 'Notas privadas del terapeuta...'}),
            'enlace_resultados': forms.URLInput(attrs={'class': 'form-control', 'placeholder': 'https://...'}),
            
            # Aqu√≠ est√° la correcci√≥n: aseguramos las comas y llaves
            'pacientes_relacionados': forms.SelectMultiple(attrs={
                'class': 'form-control select2-multiple',
                'style': 'width: 100%',
                'multiple': 'multiple'
            }), 
        }

class CitaForm(forms.ModelForm):
    class Meta:
        model = Cita
        fields = ['fecha', 'hora', 'division', 'consultorio', 'servicio', 'terapeuta', 'costo', 'metodo_pago', 'estatus', 'folio_fiscal', 'notas']
        widgets = {
            'fecha': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'hora': forms.TimeInput(attrs={'class': 'form-control', 'type': 'time'}),
            'division': forms.Select(attrs={'class': 'form-select'}),
            'consultorio': forms.Select(attrs={'class': 'form-select'}),
            'servicio': forms.Select(attrs={'class': 'form-select'}),
            'terapeuta': forms.Select(attrs={'class': 'form-select'}),
            'costo': forms.NumberInput(attrs={'class': 'form-control', 'placeholder': '500.00'}),
            'metodo_pago': forms.Select(attrs={'class': 'form-select'}),
            'estatus': forms.Select(attrs={'class': 'form-select'}),
            'folio_fiscal': forms.TextInput(attrs={'class': 'form-control', 'placeholder': 'Opcional'}),
            'notas': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }
</file>

<file path="clinica/management/commands/__init__.py">

</file>

<file path="clinica/management/commands/cargar_datos.py">
from django.core.management.base import BaseCommand
from clinica.models import Terapeuta, Consultorio, Division, Servicio

class Command(BaseCommand):
    help = 'Carga los cat√°logos iniciales desde el Excel del consultorio'

    def handle(self, *args, **kwargs):
        self.stdout.write("Iniciando carga de datos...")

        # --- 1. TERAPEUTAS ---
        terapeutas = [
            'Alejandra Dur√°n', 'Ana Juarez', 'Benjamin Villagomez', 'Carolina Gonzalez', 
            'Daniel Salazar', 'Daniela Sarmiento', 'David Bermejo', 'Enrique Arteaga', 
            'Enrique Luna', 'Esmeralda Colunga', 'Fabiola Fragoso', 'Gloria Sarmiento', 
            'Javier Mart√≠nez', 'Jennifer Torres', 'Jos√© Arcadio', 'Luc√≠a S√°nchez', 
            'Magda Charles', 'Mar√≠a Amancio - Ind', 'Mar√≠a Amancio - Par', 'Maria de la Luz', 
            'Maricela Sena', 'Perla Realme', 'Rosy Mac√≠as', 'Rafael Gonzalez', 
            'Dante Zertuche', 'Mariana Siller', 'Yessica Leija', 'Carlos Mendiola', 
            'Alondra Escalon', 'Blanca Araceli Zamora', 'Dante Zertuche Ev'
        ]
        
        for nombre in terapeutas:
            # get_or_create evita duplicados si corres el script 2 veces
            obj, created = Terapeuta.objects.get_or_create(nombre=nombre)
            if created:
                self.stdout.write(f" + Terapeuta creado: {nombre}")

        # --- 2. CONSULTORIOS ---
        consultorios = [
            'Morelos', 'Guanajuato', 'Praderas', 'Colinas', 'Zoom', 'Externo', 'Trabajo Social'
        ]
        for nombre in consultorios:
            obj, created = Consultorio.objects.get_or_create(nombre=nombre)
            if created:
                self.stdout.write(f" + Consultorio creado: {nombre}")

        # --- 3. SERVICIOS ---
        servicios = [
            'Terapia individual', 'Terapia infantil', 'Terapia de parejas', 'Terapia Familiar',
            'Evaluaci√≥n neuropsicol√≥gica', 'M√©dica psiqui√°trica', 'Medica en salud mental',
            'Consulta nutricional', 'Hipnosis', 'Psicotanatolog√≠a', 'Medica'
        ]
        for nombre in servicios:
            obj, created = Servicio.objects.get_or_create(nombre=nombre)
            if created:
                self.stdout.write(f" + Servicio creado: {nombre}")

        # --- 4. DIVISIONES ---
        divisiones = [
            'Particular', 'NEAPCO', 'GIASA', 'INSUNTE', 'DOROTHEA', 'UNIVAS', 
            'iFOOD', 'UTS', 'C√°ritas de Saltillo', 'Escuela', 'Otro'
        ]
        for nombre in divisiones:
            obj, created = Division.objects.get_or_create(nombre=nombre)
            if created:
                self.stdout.write(f" + Divisi√≥n creada: {nombre}")

        self.stdout.write(self.style.SUCCESS('¬°√âXITO! Base de datos poblada correctamente.'))
</file>

<file path="clinica/migrations/__init__.py">

</file>

<file path="clinica/migrations/0001_initial.py">
# Generated by Django 5.2.10 on 2026-01-26 01:45

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Consultorio',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=100)),
            ],
        ),
        migrations.CreateModel(
            name='Division',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=100)),
            ],
        ),
        migrations.CreateModel(
            name='Servicio',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=100)),
            ],
        ),
        migrations.CreateModel(
            name='Terapeuta',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=100)),
                ('activo', models.BooleanField(default=True)),
            ],
        ),
        migrations.CreateModel(
            name='Paciente',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('nombre', models.CharField(max_length=200, verbose_name='Nombre Completo')),
                ('fecha_nacimiento', models.DateField(verbose_name='Fecha de Nacimiento')),
                ('telefono', models.CharField(max_length=20, verbose_name='Tel√©fono (WhatsApp)')),
                ('identidad_contacto', models.CharField(choices=[('propio', 'Propio'), ('madre', 'Madre'), ('padre', 'Padre'), ('pareja', 'Pareja'), ('otro', 'Otro')], default='propio', max_length=20)),
                ('consentimiento_firmado', models.FileField(blank=True, null=True, upload_to='documentos/')),
                ('estudio_socioeconomico', models.FileField(blank=True, null=True, upload_to='documentos/')),
                ('apertura_expediente', models.FileField(blank=True, null=True, upload_to='documentos/')),
                ('resumen_clinico', models.TextField(blank=True, null=True)),
                ('enlace_resultados', models.URLField(blank=True, null=True)),
                ('fecha_registro', models.DateTimeField(auto_now_add=True)),
                ('pacientes_relacionados', models.ManyToManyField(blank=True, to='clinica.paciente')),
                ('servicio_inicial', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='clinica.servicio', verbose_name='Servicio Inicial')),
            ],
            options={
                'verbose_name': 'Paciente',
                'verbose_name_plural': 'Pacientes',
            },
        ),
        migrations.CreateModel(
            name='Cita',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('fecha', models.DateField()),
                ('hora', models.TimeField()),
                ('costo', models.DecimalField(decimal_places=2, default=500.0, max_digits=10)),
                ('metodo_pago', models.CharField(choices=[('Efectivo', 'Efectivo'), ('Transferencia', 'Transferencia'), ('Terminal', 'Terminal'), ('Pase', 'Pase'), ('Gratuito', 'Gratuito'), ('Pendiente', 'Pendiente')], default='Pendiente', max_length=20)),
                ('estatus', models.CharField(choices=[('programada', 'Programada'), ('asistio', 'Asisti√≥'), ('cancelada', 'Cancelada'), ('no_asistio', 'No Asisti√≥')], default='programada', max_length=20)),
                ('folio_fiscal', models.CharField(blank=True, max_length=100, null=True)),
                ('notas', models.TextField(blank=True, null=True)),
                ('consultorio', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='clinica.consultorio')),
                ('division', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='clinica.division')),
                ('paciente', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='citas', to='clinica.paciente')),
                ('servicio', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='clinica.servicio')),
                ('terapeuta', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='clinica.terapeuta')),
            ],
            options={
                'verbose_name': 'Cita',
                'verbose_name_plural': 'Citas',
                'ordering': ['-fecha', '-hora'],
            },
        ),
    ]
</file>

<file path="clinica/migrations/0002_paciente_sexo.py">
# Generated by Django 5.2.10 on 2026-01-26 05:44

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('clinica', '0001_initial'),
    ]

    operations = [
        migrations.AddField(
            model_name='paciente',
            name='sexo',
            field=models.CharField(choices=[('Femenino', 'Femenino'), ('Masculino', 'Masculino')], default='Femenino', max_length=20, verbose_name='Sexo'),
        ),
    ]
</file>

<file path="clinica/migrations/0003_paciente_nombre_normalizado.py">
# Generated by Django 5.2.10 on 2026-01-29 19:06

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('clinica', '0002_paciente_sexo'),
    ]

    operations = [
        migrations.AddField(
            model_name='paciente',
            name='nombre_normalizado',
            field=models.CharField(blank=True, editable=False, max_length=200),
        ),
    ]
</file>

<file path="clinica/models.py">
import unicodedata
from django.db import models

def quitar_tildes(texto):
    if not texto:
        return ""
   
    return ''.join(c for c in unicodedata.normalize('NFD', str(texto))
                   if unicodedata.category(c) != 'Mn').lower()

class Terapeuta(models.Model):
    nombre = models.CharField(max_length=100)
    activo = models.BooleanField(default=True) 

    def __str__(self):
        return self.nombre

class Consultorio(models.Model):
    nombre = models.CharField(max_length=100)
    
    def __str__(self):
        return self.nombre

class Division(models.Model):
    nombre = models.CharField(max_length=100)
    
    def __str__(self):
        return self.nombre

class Servicio(models.Model):
    nombre = models.CharField(max_length=100)
    
    def __str__(self):
        return self.nombre



class Paciente(models.Model):
    TIPO_CONTACTO_CHOICES = [
        ('propio', 'Propio'),
        ('madre', 'Madre'),
        ('padre', 'Padre'),
        ('pareja', 'Pareja'),
        ('otro', 'Otro'),
    ]

    SEXO_CHOICES = [
        ('Femenino', 'Femenino'),
        ('Masculino', 'Masculino'),
    ]

    # Datos Generales
    nombre = models.CharField(max_length=200, verbose_name="Nombre Completo")
    fecha_nacimiento = models.DateField(verbose_name="Fecha de Nacimiento")
    
    # EL CAMPO SECRETO
    nombre_normalizado = models.CharField(max_length=200, blank=True, editable=False)
    
    sexo = models.CharField(
        max_length=20, 
        choices=SEXO_CHOICES, 
        default='Femenino',
        verbose_name="Sexo"
    )

    telefono = models.CharField(max_length=20, verbose_name="Tel√©fono (WhatsApp)")
    identidad_contacto = models.CharField(max_length=20, choices=TIPO_CONTACTO_CHOICES, default='propio')
    
    # Ojo: Aseg√∫rate de tener el modelo Servicio importado o definido antes si usas esto, 
    # si no, pon 'Servicio' entre comillas como string.
    servicio_inicial = models.ForeignKey('Servicio', on_delete=models.SET_NULL, null=True, verbose_name="Servicio Inicial")

    # Documentaci√≥n
    consentimiento_firmado = models.FileField(upload_to='documentos/', blank=True, null=True)
    estudio_socioeconomico = models.FileField(upload_to='documentos/', blank=True, null=True)
    apertura_expediente = models.FileField(upload_to='documentos/', blank=True, null=True)
    resumen_clinico = models.TextField(blank=True, null=True)
    
    # Relaciones
    pacientes_relacionados = models.ManyToManyField('self', blank=True, symmetrical=True)
    enlace_resultados = models.URLField(blank=True, null=True)
    fecha_registro = models.DateTimeField(auto_now_add=True)
    
    # --- LA MAGIA (INDENTACI√ìN CORRECTA) ---
    def save(self, *args, **kwargs):
        # Antes de guardar, llenamos el campo normalizado autom√°ticamente
        self.nombre_normalizado = quitar_tildes(self.nombre)
        super(Paciente, self).save(*args, **kwargs)

    def __str__(self):
        return self.nombre

    class Meta:
        verbose_name = "Paciente"
        verbose_name_plural = "Pacientes"


class Cita(models.Model):
    ESTATUS_CHOICES = [
        ('programada', 'Programada'),
        ('asistio', 'Asisti√≥'),
        ('cancelada', 'Cancelada'),
        ('no_asistio', 'No Asisti√≥'),
    ]

    PAGO_CHOICES = [
        ('Efectivo', 'Efectivo'),
        ('Transferencia', 'Transferencia'),
        ('Terminal', 'Terminal'),
        ('Pase', 'Pase'),
        ('Gratuito', 'Gratuito'),
        ('Pendiente', 'Pendiente'),
    ]

    paciente = models.ForeignKey(Paciente, on_delete=models.CASCADE, related_name='citas')
    fecha = models.DateField()
    hora = models.TimeField()
    
 
    division = models.ForeignKey(Division, on_delete=models.SET_NULL, null=True)
    consultorio = models.ForeignKey(Consultorio, on_delete=models.SET_NULL, null=True)
    servicio = models.ForeignKey(Servicio, on_delete=models.SET_NULL, null=True)
    terapeuta = models.ForeignKey(Terapeuta, on_delete=models.SET_NULL, null=True)
    
    costo = models.DecimalField(max_digits=10, decimal_places=2, default=500.00)
    metodo_pago = models.CharField(max_length=20, choices=PAGO_CHOICES, default='Pendiente')
    estatus = models.CharField(max_length=20, choices=ESTATUS_CHOICES, default='programada')
    
    folio_fiscal = models.CharField(max_length=100, blank=True, null=True)
    notas = models.TextField(blank=True, null=True)

    def __str__(self):
        return f"{self.paciente} - {self.fecha}"

    class Meta:
        verbose_name = "Cita"
        verbose_name_plural = "Citas"
        ordering = ['-fecha', '-hora']
</file>

<file path="clinica/templates/clinica/agendar_cita.html">
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nueva Cita - INTRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --intra-primary: #26C6DA; --intra-light: #F0F4F8; --intra-dark: #37474F; }
        body { background-color: var(--intra-light); font-family: 'Inter', sans-serif; color: var(--intra-dark); }
        .form-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: none; max-width: 800px; margin: 0 auto; }
        h4 { font-family: 'Poppins', sans-serif; color: var(--intra-primary); }
        label { font-weight: 500; font-size: 0.85rem; margin-bottom: 5px; color: #546E7A; }
        .btn-primary { background-color: var(--intra-primary); border: none; border-radius: 50px; padding: 10px 30px; font-weight: 600; }
        .btn-primary:hover { background-color: #00ACC1; }
    </style>
</head>
<body>

    <div class="container py-5">
        <div class="form-card p-5">
            <div class="text-center mb-4">
                <h2 class="fw-bold">Nueva Cita</h2>
                <p class="text-muted">Paciente: <strong class="text-dark">{{ paciente.nombre }}</strong></p>
            </div>

            <form method="post">
                {% csrf_token %}
                
                <h4 class="mb-3 border-bottom pb-2"> ¬øCu√°ndo y D√≥nde?</h4>
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <label>Fecha</label>
                        {{ form.fecha }}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Hora</label>
                        {{ form.hora }}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Consultorio</label>
                        {{ form.consultorio }}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Divisi√≥n</label>
                        {{ form.division }}
                    </div>
                </div>

                <h4 class="mb-3 border-bottom pb-2"> Detalles de la Sesi√≥n</h4>
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <label>Terapeuta</label>
                        {{ form.terapeuta }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>Servicio</label>
                        {{ form.servicio }}
                    </div>
                </div>

                <h4 class="mb-3 border-bottom pb-2"> Administraci√≥n</h4>
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <label>Costo ($)</label>
                        {{ form.costo }}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>M√©todo de Pago</label>
                        {{ form.metodo_pago }}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Estatus</label>
                        {{ form.estatus }}
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>Folio Fiscal</label>
                        {{ form.folio_fiscal }}
                    </div>
                </div>

                <div class="mb-4">
                    <label>Notas / Observaciones</label>
                    {{ form.notas }}
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'detalle_paciente' paciente.id %}" class="btn btn-outline-secondary me-md-2 rounded-pill px-4">Cancelar</a>
                    <button type="submit" class="btn btn-primary shadow-sm px-5">Agendar Cita</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
</file>

<file path="clinica/templates/clinica/detalle_paciente.html">
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Expediente: {{ paciente.nombre }}</title>
    <div class="mt-3">
    <a href="{% url 'editar_paciente' paciente.id %}" class="btn btn-outline-secondary btn-sm rounded-pill w-100">
        <i class="bi bi-pencil-square me-2"></i>Editar Datos / Subir Docs
    </a>
</div>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        :root {
            --intra-primary: #26C6DA;
            --intra-secondary: #EF5350;
            --intra-dark: #37474F;
            --intra-light: #F0F4F8;
            --intra-white: #FFFFFF;
        }
        body { background-color: var(--intra-light); font-family: 'Inter', sans-serif; color: var(--intra-dark); }
        h4, h5 { font-family: 'Poppins', sans-serif; font-weight: 600; }
        
        .navbar { background-color: var(--intra-white); box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        
        .card-zen {
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.03);
            border: none;
            height: 100%;
        }

        .badge-servicio {
            background-color: #E0F7FA;
            color: var(--intra-primary);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }

        .documento-item {
            border: 1px dashed #B0BEC5;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .documento-item:hover {
            background-color: #FAFAFA;
            border-color: var(--intra-primary);
        }

        .table-citas thead th {
            font-size: 0.85rem;
            color: #78909C;
            border-bottom: 2px solid #ECEFF1;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg mb-4">
        <div class="container-fluid px-5">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
                <img src="{% static 'clinica/images/logo.png' %}" alt="Logo" style="height: 35px;" class="me-2">
                <span class="fs-6 text-muted">/ Expediente Digital</span>
            </a>
            <a href="{% url 'lista_pacientes' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="bi bi-arrow-left me-1"></i> Regresar
            </a>
        </div>
    </nav>

    <div class="container mb-5">
        
        <div class="card-zen p-4 mb-4">
            <div class="d-flex justify-content-between align-items-start flex-wrap">
                <div>
                    <h2 class="fw-bold mb-1">{{ paciente.nombre }}</h2>
                    <div class="d-flex align-items-center gap-3 mt-2 text-muted">
                        <span><i class="bi bi-cake2 me-1"></i> {{ paciente.fecha_nacimiento }}</span>
                        <span><i class="bi bi-whatsapp me-1"></i> {{ paciente.telefono }} ({{ paciente.identidad_contacto }})</span>
                    </div>
                </div>
                <div class="text-end mt-2 mt-md-0">
                   <span class="badge-servicio">{{ paciente.servicio_inicial }}</span>
                    <div class="mt-2">
                        <small class="text-muted">Expediente #{{ paciente.id }}</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            
            <div class="col-lg-8">
                <div class="card-zen p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0"><i class="bi bi-clock-history me-2 text-primary"></i>Historial de Citas</h5>
                        <a href="{% url 'agendar_cita' paciente.id %}" class="btn btn-sm btn-primary rounded-pill">
    <i class="bi bi-plus-lg"></i> Agendar
</a>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-citas">
                            <thead>
                                <tr>
                                    <th>FECHA</th>
                                    <th>TERAPEUTA</th>
                                    <th>UBICACI√ìN</th>
                                    <th>PAGO</th>
                                    <th>ESTATUS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cita in citas %}
                                <tr>
                                    <td class="fw-bold">{{ cita.fecha|date:"d M Y" }} <small class="text-muted d-block">{{ cita.hora|time:"H:i" }}</small></td>
                                    <td>{{ cita.terapeuta }}</td>
                                    <td>{{ cita.consultorio }}</td>
                                    <td>
                                        ${{ cita.costo }}
                                        {% if cita.metodo_pago == 'pendiente' %}
                                            <i class="bi bi-exclamation-circle text-danger" title="Pendiente"></i>
                                        {% else %}
                                            <i class="bi bi-check-circle-fill text-success" title="Pagado"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if cita.estatus == 'asistio' %}
                                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill">Asisti√≥</span>
                                        {% elif cita.estatus == 'programada' %}
                                            <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">Programada</span>
                                        {% else %}
                                            <span class="badge bg-secondary bg-opacity-10 text-secondary rounded-pill">{{ cita.estatus }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        No hay citas registradas para este paciente.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                
                <div class="card-zen p-4 mb-4">
                    <h5 class="mb-3">Documentaci√≥n</h5>
                    
                    <div class="d-flex flex-column gap-3">
                        <div class="documento-item">
                            {% if paciente.consentimiento_firmado %}
                                <a href="{{ paciente.consentimiento_firmado.url }}" target="_blank" class="text-decoration-none text-success fw-bold">
                                    <i class="bi bi-file-earmark-check fs-4 d-block"></i>
                                    Ver Consentimiento
                                </a>
                            {% else %}
                                <div class="text-muted">
                                    <i class="bi bi-file-earmark-x fs-4 d-block"></i>
                                    Consentimiento Pendiente
                                </div>
                            {% endif %}
                        </div>

                        <div class="documento-item">
                            {% if paciente.estudio_socioeconomico %}
                                <a href="{{ paciente.estudio_socioeconomico.url }}" target="_blank" class="text-decoration-none text-primary fw-bold">
                                    <i class="bi bi-clipboard-data fs-4 d-block"></i>
                                    Ver Estudio S.E.
                                </a>
                            {% else %}
                                <div class="text-muted">
                                    <i class="bi bi-clipboard fs-4 d-block"></i>
                                    Estudio S.E. Pendiente
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="card-zen p-4 mb-4 bg-light">
                    <h5 class="mb-3"><i class="bi bi-lock-fill me-2"></i>Resumen Cl√≠nico</h5>
                    {% if paciente.resumen_clinico %}
                        <p class="small text-muted mb-0">{{ paciente.resumen_clinico|linebreaks }}</p>
                    {% else %}
                        <p class="small text-muted fst-italic">Sin notas cl√≠nicas registradas.</p>
                    {% endif %}
                    
                </div>
                
                <div class="mb-4">
    <h5 class="fw-bold text-muted mb-3">Familiares / Relaciones</h5>
    {% if paciente.pacientes_relacionados.all %}
        <div class="d-flex flex-wrap gap-2">
            {% for familiar in paciente.pacientes_relacionados.all %}
                <a href="{% url 'detalle_paciente' familiar.id %}" class="btn btn-outline-info btn-sm rounded-pill">
                    <i class="bi bi-person-fill me-1"></i> {{ familiar.nombre }}
                </a>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted small fst-italic">No hay familiares registrados.</p>
    {% endif %}
</div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
</file>

<file path="clinica/templates/clinica/editar_paciente.html">
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Editar Expediente - INTRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container .select2-selection--multiple {
        min-height: 38px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #26C6DA; 
        border: none;
        color: white;
        border-radius: 20px;
        padding: 2px 10px;
        font-size: 0.85rem;
        margin-top: 6px;
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
        border-right: 1px solid rgba(255,255,255,0.3);
    }
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        background-color: #00ACC1;
    }
</style>
    <style>
        :root { --intra-primary: #26C6DA; --intra-light: #F0F4F8; --intra-dark: #37474F; }
        body { background-color: var(--intra-light); font-family: 'Inter', sans-serif; color: var(--intra-dark); }
        .form-card { background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: none; }
        h4 { font-family: 'Poppins', sans-serif; font-size: 1.1rem; color: var(--intra-primary); margin-bottom: 1rem; }
        label { font-weight: 500; font-size: 0.85rem; margin-bottom: 5px; color: #546E7A; }
    </style>
</head>
<body>

    <div class="container py-5">
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold m-0">Editar Expediente: {{ paciente.nombre }}</h3>
                <div>
                    <a href="{% url 'detalle_paciente' paciente.id %}" class="btn btn-outline-secondary rounded-pill me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary rounded-pill px-4 text-white">Guardar Cambios</button>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="form-card p-4 h-100">
                        <h4>üë§ Datos Generales</h4>
                        <div class="mb-3">
                            <label>Nombre Completo</label>
                            {{ form.nombre }}
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Fecha Nacimiento</label>
                                {{ form.fecha_nacimiento }}
                            </div>
                            <div class="col-md-6 mb-3">
    <label>Servicio Inicial</label>
    {{ form.servicio_inicial }}
</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Tel√©fono</label>
                                {{ form.telefono }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Identidad Contacto</label>
                                {{ form.identidad_contacto }}
                            </div>
                        </div>
                    </div>
                </div>
               <div class="mb-3">
    <label>Familiares / Pacientes Relacionados</label>
    {{ form.pacientes_relacionados }}
</div>
                <div class="col-lg-6">
                    <div class="form-card p-4 mb-4">
                        <h4> Documentaci√≥n Digital</h4>
                        <div class="mb-3">
                            <label>Consentimiento Informado (PDF/Img)</label>
                            {{ form.consentimiento_firmado }}
                        </div>
                        <div class="mb-3">
                            <label>Estudio Socioecon√≥mico</label>
                            {{ form.estudio_socioeconomico }}
                        </div>
                        <div class="mb-3">
                            <label>Apertura de Expediente</label>
                            {{ form.apertura_expediente }}
                        </div>
                         <div class="mb-3">
                            <label>Enlace a Resultados (Google Drive)</label>
                            {{ form.enlace_resultados }}
                        </div>
                    </div>

                    <div class="form-card p-4">
                        <h4> Resumen Cl√≠nico (Privado)</h4>
                        {{ form.resumen_clinico }}
                    </div>
                </div>
            </div>
        </form>
    </div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        $('.select2-multiple').select2({
            placeholder: " Busca y selecciona familiares...",
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return "No se encontraron pacientes";
                }
            }
        });
    });
</script>
</body>
</html>
</file>

<file path="clinica/templates/clinica/home.html">
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INTRA - Gesti√≥n Cl√≠nica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            --intra-primary: #26C6DA;
            --intra-secondary: #EF5350;
            --intra-dark: #37474F;
            --intra-light: #F0F4F8;
            --intra-white: #FFFFFF;
        }

        body {
            background-color: var(--intra-light);
            font-family: 'Inter', sans-serif;
            color: var(--intra-dark);
        }

        h1, h2, h3, h4, h5, .navbar-brand {
            font-family: 'Poppins', sans-serif;
        }

        .btn-primary {
            background-color: var(--intra-primary);
            border: none;
            border-radius: 50px;
            padding: 10px 25px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(38, 198, 218, 0.3);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #00ACC1;
            transform: translateY(-2px);
        }

        .btn-outline-secondary {
            border-color: #CFD8DC;
            color: #78909C;
            border-radius: 50px;
            padding: 10px 25px;
        }

        .btn-outline-secondary:hover {
            background-color: #ECEFF1;
            color: var(--intra-dark);
            border-color: #B0BEC5;
        }

        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        .navbar {
            background-color: var(--intra-white);
            box-shadow: 0 2px 15px rgba(0,0,0,0.03);
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .navbar-brand img {
            height: 40px;
            width: auto;
        }

        .welcome-text {
            color: #90A4AE;
            font-size: 0.9rem;
        }
        
        .stat-icon-wrapper {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
               <img src="{% static 'clinica/images/logo.png' %}" alt="Logo INTRA" class="me-2">
            </a>
            
           <div class="d-flex align-items-center">
    <span class="me-3 text-muted fw-bold d-none d-md-block">
        Hola, {{ user.username|title }} </span>
    
    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger btn-sm rounded-circle" title="Cerrar Sesi√≥n">
            <i class="bi bi-box-arrow-right"></i>
        </button>
    </form>
</div>
        </div>
    </nav>

    <div class="container" style="margin-top: 100px;">
        
        <div class="row mb-4">
            <div class="col-12 text-center text-md-start">
                <h2 class="fw-bold text-secondary-emphasis">Bienvenido</h2>
                <p class="text-muted">Resumen de actividad del consultorio.</p>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card p-4 p-md-5 text-center mb-4">
                    <div class="mb-4">
                      <img src="{% static 'clinica/images/logo.png' %}" alt="INTRA Logo" style="height: 80px; opacity: 0.9;">
                    </div>
                    <h3 class="fw-bold mb-3">Sistema de Gesti√≥n Cl√≠nica</h3>
                    <p class="text-muted mb-4 px-lg-5">
                        Administraci√≥n centralizada de expedientes, citas y documentaci√≥n.
                    </p>
                    
                  <div class="d-grid gap-3 d-sm-flex justify-content-sm-center">
                        
                        <a href="{% url 'lista_pacientes' %}" class="btn btn-primary btn-lg">
                            <i class="bi bi-search me-2"></i>Buscar Paciente
                        </a> 
                        <button class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-plus-lg me-2"></i>Nueva Cita
                        </button>
                        
                    </div>
                </div>
            </div>
        </div>

       <div class="row g-3">
            <div class="col-md-4">
                <div class="card p-3 d-flex flex-row align-items-center h-100 shadow-sm border-0">
                    <div class="stat-icon-wrapper me-3" style="background-color: #E0F7FA; color: var(--intra-primary); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                        <i class="bi bi-calendar-check fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0">{{ citas_hoy }} Citas</h5>
                        <small class="text-muted">Programadas para hoy</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3 d-flex flex-row align-items-center h-100 shadow-sm border-0">
                    <div class="stat-icon-wrapper me-3" style="background-color: #FFEBEE; color: var(--intra-secondary); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                        <i class="bi bi-person-plus fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0">{{ pacientes_nuevos }} Nuevos</h5>
                        <small class="text-muted">Pacientes este mes</small>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card p-3 d-flex flex-row align-items-center h-100 shadow-sm border-0">
                    <div class="stat-icon-wrapper me-3" style="background-color: #F3E5F5; color: #AB47BC; width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                        <i class="bi bi-exclamation-circle fs-4"></i>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-0">{{ reportes_pendientes }} Pendientes</h5>
                        <small class="text-muted">Citas sin cerrar</small>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
</file>

<file path="clinica/templates/clinica/lista_pacientes.html">
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pacientes - INTRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        /* Reutilizamos tus variables para consistencia */
        :root {
            --intra-primary: #26C6DA;
            --intra-secondary: #EF5350;
            --intra-dark: #37474F;
            --intra-light: #F0F4F8;
            --intra-white: #FFFFFF;
        }
        body { background-color: var(--intra-light); font-family: 'Inter', sans-serif; color: var(--intra-dark); }
        h2 { font-family: 'Poppins', sans-serif; }
        
        .navbar { background-color: var(--intra-white); box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        
        /* Estilos de la Tabla Zen */
        .table-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden; /* Para que los bordes redondos funcionen en la tabla */
            border: none;
        }
        .table thead th {
            background-color: #E0F7FA;
            color: var(--intra-dark);
            font-weight: 600;
            border: none;
            padding: 15px;
        }
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-bottom: 1px solid #ECEFF1;
        }
        .badge-servicio {
            background-color: #E1BEE7;
            color: #7B1FA2;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg mb-5">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
                <img src="{% static 'clinica/images/logo.png' %}" alt="Logo" style="height: 35px;" class="me-2">
                <span class="fs-6 text-muted">/ Pacientes</span>
            </a>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
                <i class="bi bi-arrow-left me-1"></i> Volver
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">Expedientes Activos</h2>
           <a href="{% url 'registrar_paciente' %}" class="btn btn-primary rounded-pill shadow-sm">
    <i class="bi bi-plus-lg me-2"></i>Nuevo Paciente
</a>
        </div>

        <div class="card table-card p-3"><div class="row mb-4">
    <div class="col-md-6">
        <form method="get" class="d-flex">
            <input type="text" name="q" class="form-control me-2 rounded-pill" placeholder="Buscar por nombre o tel√©fono..." value="{{ request.GET.q }}">
            <button type="submit" class="btn btn-primary rounded-pill px-4">
                <i class="bi bi-search"></i>
            </button>
            {% if request.GET.q %}
                <a href="{% url 'lista_pacientes' %}" class="btn btn-outline-secondary rounded-pill ms-2" title="Limpiar filtro">
                    <i class="bi bi-x-lg"></i>
                </a>
            {% endif %}
        </form>
    </div>
</div>

<div class="card shadow-sm border-0"> ...
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Servicio</th>
                        <th>Tel√©fono</th>
                        <th>Contacto</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for paciente in pacientes %}
                    <tr>
                        <td class="fw-bold">{{ paciente.nombre }}</td>
                        <td><span class="badge-servicio">{{ paciente.servicio_inicial }}</span></td>
                        <td class="text-muted">{{ paciente.telefono }}</td>
                        <td>
                            {% if paciente.identidad_contacto == 'propio' %}
                                <span class="text-success"><i class="bi bi-person-check"></i> Propio</span>
                            {% else %}
                                <span class="text-warning"><i class="bi bi-people"></i> {{ paciente.identidad_contacto|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'detalle_paciente' paciente.id %}" class="btn btn-sm btn-light text-primary rounded-circle">
    <i class="bi bi-eye"></i>
</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            No hay pacientes registrados a√∫n.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</body>
</html>
</file>

<file path="clinica/templates/clinica/registro_paciente.html">
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Paciente - INTRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
    /* Ajuste para que la caja tenga la altura correcta de Bootstrap */
    .select2-container .select2-selection--multiple {
        min-height: 38px;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
    }
    
    /* El color de las "burbujitas" seleccionadas (Tu color turquesa) */
    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background-color: #26C6DA; 
        border: none;
        color: white;
        border-radius: 20px; /* Bordes redonditos */
        padding: 2px 10px;
        font-size: 0.85rem;
        margin-top: 6px;
    }

    /* La "X" para borrar la etiqueta */
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
        color: white;
        margin-right: 5px;
        border-right: 1px solid rgba(255,255,255,0.3);
    }
    
    .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
        background-color: #00ACC1;
        color: white;
    }
</style>
    <style>
        :root {
            --intra-primary: #26C6DA;
            --intra-secondary: #EF5350;
            --intra-dark: #37474F;
            --intra-light: #F0F4F8;
            --intra-white: #FFFFFF;
        }
        body { background-color: var(--intra-light); font-family: 'Inter', sans-serif; color: var(--intra-dark); }
        h2, h4 { font-family: 'Poppins', sans-serif; }
        
        .navbar { background-color: var(--intra-white); box-shadow: 0 2px 15px rgba(0,0,0,0.03); }
        
        .form-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            border: none;
            max-width: 600px;
            margin: 0 auto;
        }

        .btn-primary {
            background-color: var(--intra-primary);
            border: none;
            border-radius: 50px;
            padding: 10px 30px;
            font-weight: 600;
        }
        
        .btn-primary:hover { background-color: #00ACC1; }
        
        label { font-weight: 500; font-size: 0.9rem; margin-bottom: 5px; color: #546E7A; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg mb-5">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="{% url 'home' %}">
                <img src="{% static 'clinica/images/logo.png' %}" alt="Logo" style="height: 35px;" class="me-2">
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="form-card p-5">
            <div class="text-center mb-4">
                <h2 class="fw-bold mb-1">Nuevo Expediente</h2>
                <p class="text-muted">Ingresa los datos del paciente</p>
            </div>

            <form method="post">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label>Nombre Completo</label>
                    {{ form.nombre }}
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Fecha de Nacimiento</label>
                        {{ form.fecha_nacimiento }}
                    </div>
                    <div class="col-md-6 mb-3">
    <label>Servicio Inicial</label>
    {{ form.servicio_inicial }}
</div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label>Tel√©fono (WhatsApp)</label>
                        {{ form.telefono }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label>¬øDe qui√©n es el n√∫mero?</label>
                        {{ form.identidad_contacto }}
                    </div>
                </div>
<div class="mb-3">
    <label>Familiares / Pacientes Relacionados</label>
    
    {{ form.pacientes_relacionados }}
</div>
                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-primary btn-lg shadow-sm">
                        Guardar Paciente
                    </button>
                    <a href="{% url 'lista_pacientes' %}" class="btn btn-link text-muted text-decoration-none">
                        Cancelar
                    </a>
                    
                </div>
            </form>
        </div>
    </div>
    
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // Buscamos el campo que tiene la clase 'select2-multiple' (que pusimos en forms.py)
        $('.select2-multiple').select2({
            placeholder: "üîç Busca y selecciona familiares...",
            allowClear: true,
            width: '100%', // Para que ocupe todo el ancho
            language: {
                noResults: function() {
                    return "No se encontraron pacientes";
                }
            }
        });
    });
</script>
</body>
</html>
</file>

<file path="clinica/templates/registration/login.html">
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Acceso Restringido - INTRA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #F0F4F8;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Poppins', sans-serif;
        }
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        .logo-login { height: 60px; margin-bottom: 20px; }
        .form-control {
            border-radius: 50px;
            padding: 10px 20px;
            background-color: #F8F9FA;
            border: 1px solid #E0E0E0;
            margin-bottom: 15px;
        }
        .btn-login {
            width: 100%;
            border-radius: 50px;
            padding: 10px;
            background-color: #26C6DA;
            border: none;
            font-weight: 600;
            margin-top: 10px;
        }
        .btn-login:hover { background-color: #00ACC1; }
    </style>
</head>
<body>

    <div class="login-card">
        {% load static %}
        <img src="{% static 'clinica/images/logo.png' %}" alt="Logo" class="logo-login">
        
        <h4 class="mb-4 text-muted">Iniciar Sesi√≥n</h4>

        <form method="post">
            {% csrf_token %}
            
            {% if form.errors %}
                <div class="alert alert-danger py-2 small">Usuario o contrase√±a incorrectos</div>
            {% endif %}

            <input type="text" name="username" class="form-control" placeholder="Usuario" required autofocus>
            <input type="password" name="password" class="form-control" placeholder="Contrase√±a" required>

            <button type="submit" class="btn btn-primary btn-login">Entrar al Sistema</button>
        </form>
        
        <p class="mt-4 text-muted small">Consultorio de Psicolog√≠a Integral</p>
    </div>

</body>
</html>
</file>

<file path="clinica/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="clinica/utils.py">
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime

def sincronizar_google_sheet(cita):
   
    scope = ['https://spreadsheets.google.com/feeds', 'https://www.googleapis.com/auth/drive']
    
   
    creds = ServiceAccountCredentials.from_json_keyfile_name('credenciales_google.json', scope)
    client = gspread.authorize(creds)

    
    sheet = client.open("REPORTE GENERAL").worksheet("Datos")

    
    periodo = cita.fecha.strftime("%B %Y").capitalize() 
    
    
    fila_nueva = [
        cita.fecha.day,                 # Columna A: Dia
        periodo,                        # Columna B: Periodo
        str(cita.hora)[:5],             # Columna C: Hora
        str(cita.division),             # Columna D: Divisi√≥n
        str(cita.paciente.nombre),      # Columna E: Paciente
        str(cita.paciente.sexo),        # Columna F: Sexo
        str(cita.servicio),             # Columna G: Servicio
        str(cita.terapeuta),            # Columna H: Terapeuta
        str(cita.consultorio),          # Columna I: Consultorio
        float(cita.costo),              # Columna J: Pago
        cita.metodo_pago,               # Columna K: M√©todo
        "",                             # Columna L: Tarjeta (Vac√≠o por ahora)
        cita.folio_fiscal or "NA",      # Columna M: Folio
        cita.notas or "",               # Columna N: Notas
        str(cita.fecha)                 # Columna O: Fecha de pago
    ]

   
    sheet.append_row(fila_nueva)
    print(" Cita sincronizada con Excel")
</file>

<file path="clinica/views.py">
from django.shortcuts import render, redirect, get_object_or_404
from .models import Paciente, Cita
from .forms import PacienteForm , CitaForm
from django.utils import timezone  
from django.db.models import Q    
from .utils import sincronizar_google_sheet 
from django.contrib.auth.decorators import login_required
import unicodedata

def quitar_tildes(texto):
    if not texto:
        return ""
    return ''.join(c for c in unicodedata.normalize('NFD', str(texto))
                   if unicodedata.category(c) != 'Mn').lower()

@login_required
def home(request):
    hoy = timezone.now().date()
    
    citas_hoy = Cita.objects.filter(fecha=hoy, estatus='programada').count()
    
    pacientes_nuevos = Paciente.objects.filter(fecha_registro__month=hoy.month).count()
    
    reportes_pendientes = Cita.objects.filter(fecha__lt=hoy, estatus='programada').count()

    return render(request, 'clinica/home.html', {
        'citas_hoy': citas_hoy,
        'pacientes_nuevos': pacientes_nuevos,
        'reportes_pendientes': reportes_pendientes
    })
# Aseg√∫rate de tener esto arriba: from django.db.models import Q

@login_required
def lista_pacientes(request):
    query = request.GET.get('q') 
    
    if query:
        # A. Limpiamos lo que escribi√≥ el usuario (Ej: "√Ångel" -> "angel")
        q_limpio = quitar_tildes(query)

        # B. Buscamos:
        # - En 'nombre_normalizado' usamos la versi√≥n limpia ('angel')
        # - En 'telefono' usamos la versi√≥n original (n√∫meros)
        pacientes = Paciente.objects.filter(
            Q(nombre_normalizado__icontains=q_limpio) | 
            Q(telefono__icontains=query)
        ).order_by('-fecha_registro')
    else:
        pacientes = Paciente.objects.all().order_by('-fecha_registro')

    return render(request, 'clinica/lista_pacientes.html', {'pacientes': pacientes})
@login_required
def registrar_paciente(request):
    if request.method == 'POST':
        form = PacienteForm(request.POST)
        if form.is_valid():
            form.save()
            return redirect('lista_pacientes')
    else:
        form = PacienteForm()
    return render(request, 'clinica/registro_paciente.html', {'form': form})
@login_required
def detalle_paciente(request, paciente_id):
    paciente = get_object_or_404(Paciente, id=paciente_id)
    citas = paciente.citas.all()
    return render(request, 'clinica/detalle_paciente.html', {
        'paciente': paciente,
        'citas': citas
    })
@login_required
def agendar_cita(request, paciente_id):
    paciente = get_object_or_404(Paciente, id=paciente_id)
    
    if request.method == 'POST':
        form = CitaForm(request.POST)
        if form.is_valid():
            cita = form.save(commit=False)
            cita.paciente = paciente  # Aqu√≠ vinculamos la cita al paciente autom√°ticamente
            cita.save()
            return redirect('detalle_paciente', paciente_id=paciente.id)
    else:
        # Pre-llenamos el terapeuta por defecto si quieres, o lo dejamos vac√≠o
        form = CitaForm(initial={'costo': 500})
    
    return render(request, 'clinica/agendar_cita.html', {'form': form, 'paciente': paciente})
@login_required
def editar_paciente(request, paciente_id):
    paciente = get_object_or_404(Paciente, id=paciente_id)
    
    if request.method == 'POST':
        # FILES es necesario para recibir archivos (PDFs, fotos)
        form = PacienteForm(request.POST, request.FILES, instance=paciente)
        if form.is_valid():
            form.save()
            return redirect('detalle_paciente', paciente_id=paciente.id)
    else:
        form = PacienteForm(instance=paciente)
    
    return render(request, 'clinica/editar_paciente.html', {'form': form, 'paciente': paciente})
@login_required
def agendar_cita(request, paciente_id):
    paciente = get_object_or_404(Paciente, id=paciente_id)
    
    if request.method == 'POST':
        form = CitaForm(request.POST)
        if form.is_valid():
            cita = form.save(commit=False)
            cita.paciente = paciente
            cita.save()
            
           
            try:
                sincronizar_google_sheet(cita)
                print("‚úÖ Sincronizaci√≥n exitosa")
            except Exception as e:
                print(f"‚ö†Ô∏è Error al sincronizar con Google: {e}")
            

            return redirect('detalle_paciente', paciente_id=paciente.id)
    else:
        form = CitaForm(initial={'costo': 500})
    
    return render(request, 'clinica/agendar_cita.html', {'form': form, 'paciente': paciente})
</file>

<file path="configuracion.json">
[
{
  "model": "clinica.terapeuta",
  "pk": 1,
  "fields": {
    "nombre": "Alejandra Dur√°n",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 2,
  "fields": {
    "nombre": "Ana Juarez",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 3,
  "fields": {
    "nombre": "Benjamin Villagomez",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 4,
  "fields": {
    "nombre": "Carolina Gonzalez",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 5,
  "fields": {
    "nombre": "Daniel Salazar",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 6,
  "fields": {
    "nombre": "Daniela Sarmiento",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 7,
  "fields": {
    "nombre": "David Bermejo",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 8,
  "fields": {
    "nombre": "Enrique Arteaga",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 9,
  "fields": {
    "nombre": "Enrique Luna",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 10,
  "fields": {
    "nombre": "Esmeralda Colunga",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 11,
  "fields": {
    "nombre": "Fabiola Fragoso",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 12,
  "fields": {
    "nombre": "Gloria Sarmiento",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 13,
  "fields": {
    "nombre": "Javier Mart√≠nez",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 14,
  "fields": {
    "nombre": "Jennifer Torres",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 15,
  "fields": {
    "nombre": "Jos√© Arcadio",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 16,
  "fields": {
    "nombre": "Luc√≠a S√°nchez",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 17,
  "fields": {
    "nombre": "Magda Charles",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 18,
  "fields": {
    "nombre": "Mar√≠a Amancio - Ind",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 19,
  "fields": {
    "nombre": "Mar√≠a Amancio - Par",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 20,
  "fields": {
    "nombre": "Maria de la Luz",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 21,
  "fields": {
    "nombre": "Maricela Sena",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 22,
  "fields": {
    "nombre": "Perla Realme",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 23,
  "fields": {
    "nombre": "Rosy Mac√≠as",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 24,
  "fields": {
    "nombre": "Rafael Gonzalez",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 25,
  "fields": {
    "nombre": "Dante Zertuche",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 26,
  "fields": {
    "nombre": "Mariana Siller",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 27,
  "fields": {
    "nombre": "Yessica Leija",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 28,
  "fields": {
    "nombre": "Carlos Mendiola",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 29,
  "fields": {
    "nombre": "Alondra Escalon",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 30,
  "fields": {
    "nombre": "Blanca Araceli Zamora",
    "activo": true
  }
},
{
  "model": "clinica.terapeuta",
  "pk": 31,
  "fields": {
    "nombre": "Dante Zertuche Ev",
    "activo": true
  }
},
{
  "model": "clinica.consultorio",
  "pk": 1,
  "fields": {
    "nombre": "Morelos"
  }
},
{
  "model": "clinica.consultorio",
  "pk": 2,
  "fields": {
    "nombre": "Guanajuato"
  }
},
{
  "model": "clinica.consultorio",
  "pk": 3,
  "fields": {
    "nombre": "Praderas"
  }
},
{
  "model": "clinica.consultorio",
  "pk": 4,
  "fields": {
    "nombre": "Colinas"
  }
},
{
  "model": "clinica.consultorio",
  "pk": 5,
  "fields": {
    "nombre": "Zoom"
  }
},
{
  "model": "clinica.consultorio",
  "pk": 6,
  "fields": {
    "nombre": "Externo"
  }
},
{
  "model": "clinica.consultorio",
  "pk": 7,
  "fields": {
    "nombre": "Trabajo Social"
  }
},
{
  "model": "clinica.division",
  "pk": 1,
  "fields": {
    "nombre": "Particular"
  }
},
{
  "model": "clinica.division",
  "pk": 2,
  "fields": {
    "nombre": "NEAPCO"
  }
},
{
  "model": "clinica.division",
  "pk": 3,
  "fields": {
    "nombre": "GIASA"
  }
},
{
  "model": "clinica.division",
  "pk": 4,
  "fields": {
    "nombre": "INSUNTE"
  }
},
{
  "model": "clinica.division",
  "pk": 5,
  "fields": {
    "nombre": "DOROTHEA"
  }
},
{
  "model": "clinica.division",
  "pk": 6,
  "fields": {
    "nombre": "UNIVAS"
  }
},
{
  "model": "clinica.division",
  "pk": 7,
  "fields": {
    "nombre": "iFOOD"
  }
},
{
  "model": "clinica.division",
  "pk": 8,
  "fields": {
    "nombre": "UTS"
  }
},
{
  "model": "clinica.division",
  "pk": 9,
  "fields": {
    "nombre": "C√°ritas de Saltillo"
  }
},
{
  "model": "clinica.division",
  "pk": 10,
  "fields": {
    "nombre": "Escuela"
  }
},
{
  "model": "clinica.division",
  "pk": 11,
  "fields": {
    "nombre": "Otro"
  }
},
{
  "model": "clinica.servicio",
  "pk": 1,
  "fields": {
    "nombre": "Terapia individual"
  }
},
{
  "model": "clinica.servicio",
  "pk": 2,
  "fields": {
    "nombre": "Terapia infantil"
  }
},
{
  "model": "clinica.servicio",
  "pk": 3,
  "fields": {
    "nombre": "Terapia de parejas"
  }
},
{
  "model": "clinica.servicio",
  "pk": 4,
  "fields": {
    "nombre": "Terapia Familiar"
  }
},
{
  "model": "clinica.servicio",
  "pk": 5,
  "fields": {
    "nombre": "Evaluaci√≥n neuropsicol√≥gica"
  }
},
{
  "model": "clinica.servicio",
  "pk": 6,
  "fields": {
    "nombre": "M√©dica psiqui√°trica"
  }
},
{
  "model": "clinica.servicio",
  "pk": 7,
  "fields": {
    "nombre": "Medica en salud mental"
  }
},
{
  "model": "clinica.servicio",
  "pk": 8,
  "fields": {
    "nombre": "Consulta nutricional"
  }
},
{
  "model": "clinica.servicio",
  "pk": 9,
  "fields": {
    "nombre": "Hipnosis"
  }
},
{
  "model": "clinica.servicio",
  "pk": 10,
  "fields": {
    "nombre": "Psicotanatolog√≠a"
  }
},
{
  "model": "clinica.servicio",
  "pk": 11,
  "fields": {
    "nombre": "Medica"
  }
}
]
</file>

<file path="core/__init__.py">

</file>

<file path="core/asgi.py">
"""
ASGI config for core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_asgi_application()
</file>

<file path="core/settings.py">
"""
Django settings for core project.

Generated by 'django-admin startproject' using Django 5.2.10.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-h_ibx(&xek172eft1@4el$9j7l$7%e1b^%v%27-j&%b7(hu256'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'clinica',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'core.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
import os

# ... (c√≥digo existente)

STATIC_URL = '/static/'

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

LOGIN_REDIRECT_URL = 'home'

LOGOUT_REDIRECT_URL = 'login'
</file>

<file path="core/urls.py">
from django.contrib import admin
from django.urls import path, include  
from django.conf import settings
from django.conf.urls.static import static
from clinica import views as clinica_views

urlpatterns = [
    path('admin/', admin.site.urls),
    
    
    path('accounts/', include('django.contrib.auth.urls')),
    
    
    path('', clinica_views.home, name='home'),
    path('pacientes/', clinica_views.lista_pacientes, name='lista_pacientes'),
    path('pacientes/nuevo/', clinica_views.registrar_paciente, name='registrar_paciente'),
    path('pacientes/<int:paciente_id>/', clinica_views.detalle_paciente, name='detalle_paciente'),
    path('pacientes/<int:paciente_id>/editar/', clinica_views.editar_paciente, name='editar_paciente'),
    path('pacientes/<int:paciente_id>/agendar/', clinica_views.agendar_cita, name='agendar_cita'),
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
</file>

<file path="core/wsgi.py">
"""
WSGI config for core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_wsgi_application()
</file>

<file path="limpiar_pacientes.py">
import pandas as pd
import difflib

def limpiar_lista():
    print("üìÇ Leyendo archivo REVISAR_PACIENTES.xlsx - Sheet1.csv...")
    
    # 1. Cargamos el archivo CSV que subiste
    # (Aseg√∫rate de que el archivo est√© en la misma carpeta)
    try:
        df = pd.read_csv('REVISAR_PACIENTES.xlsx - Sheet1.csv')
    except:
        # Si falla, intentamos leerlo como Excel normal si ya lo convertiste
        try:
            df = pd.read_excel('REVISAR_PACIENTES.xlsx')
        except:
            print("‚ùå No encuentro el archivo. Aseg√∫rate que se llame 'REVISAR_PACIENTES.xlsx - Sheet1.csv' o similar.")
            return

    # Limpiamos espacios en los nombres de columnas
    df.columns = df.columns.str.strip()
    
    # Buscamos la columna correcta
    col_nombre = 'Nombre_Paciente'
    if col_nombre not in df.columns:
        print(f"‚ö†Ô∏è No encontr√© la columna '{col_nombre}'. Usando la primera columna disponible.")
        col_nombre = df.columns[0]

    # Convertimos a lista y ordenamos por longitud (los m√°s largos primero son "m√°s confiables")
    nombres_originales = df[col_nombre].dropna().unique().tolist()
    # Ordenamos: Primero los m√°s largos. As√≠ "Juan Perez Gzz" tiene prioridad sobre "Juan Perez"
    nombres_originales.sort(key=len, reverse=True)

    pacientes_limpios = {}
    nombres_finales = []

    print(f"üßπ Analizando {len(nombres_originales)} nombres √∫nicos con L√≥gica Difusa...")

    for nombre in nombres_originales:
        nombre_str = str(nombre).strip()
        encontrado = False
        
        # Comparamos con los nombres que ya dimos por "buenos"
        for final in nombres_finales:
            # difflib compara qu√© tan parecidos son (0.0 a 1.0)
            similitud = difflib.SequenceMatcher(None, nombre_str.lower(), final.lower()).ratio()
            
            # SI SE PARECEN M√ÅS DEL 85% (Ajustable)
            if similitud > 0.85:
                # Es la misma persona! Lo asignamos al nombre "oficial" (el m√°s largo que ya guardamos)
                pacientes_limpios[nombre_str] = final
                encontrado = True
                print(f"   üîó Fusionando: '{nombre_str}'  --->  '{final}'")
                break
        
        if not encontrado:
            # Es una persona nueva
            nombres_finales.append(nombre_str)
            pacientes_limpios[nombre_str] = nombre_str

    # 2. Creamos el archivo final
    print("-" * 30)
    print(f"‚úÖ Reducci√≥n: De {len(nombres_originales)} pasamos a {len(nombres_finales)} pacientes reales.")
    
    df_final = pd.DataFrame(nombres_finales, columns=['Nombre_Paciente'])
    df_final.sort_values(by='Nombre_Paciente', inplace=True)
    
    nombre_archivo_salida = "PACIENTES_LIMPIOS.xlsx"
    df_final.to_excel(nombre_archivo_salida, index=False)
    print(f"üéâ ¬°Listo! Archivo '{nombre_archivo_salida}' creado.")

if __name__ == "__main__":
    limpiar_lista()
</file>

<file path="manage.py">
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
</file>

<file path="passenger_wsgi.py">
import os
import sys
from core.wsgi import application

sys.path.insert(0, os.path.dirname(__file__))

environ = os.environ.setdefault("DJANGO_SETTINGS_MODULE", "core.settings")
</file>

<file path="requirements.txt">
asgiref==3.11.0
certifi==2026.1.4
charset-normalizer==3.4.4
Django==5.2.10
et_xmlfile==2.0.0
google-auth==2.47.0
google-auth-oauthlib==1.2.4
gspread==6.2.1
httplib2==0.31.2
idna==3.11
numpy==2.2.6
oauth2client==4.1.3
oauthlib==3.3.1
openpyxl==3.1.5
pandas==2.3.3
pillow==12.1.0
pyasn1==0.6.2
pyasn1_modules==0.4.2
pyparsing==3.3.2
python-dateutil==2.9.0.post0
pytz==2025.2
requests==2.32.5
requests-oauthlib==2.0.0
rsa==4.9.1
six==1.17.0
sqlparse==0.5.5
typing_extensions==4.15.0
tzdata==2025.3
urllib3==2.6.3
mysqlclient
</file>

</files>
