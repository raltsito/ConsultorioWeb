{% extends 'clinica/base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-warning text-dark fw-bold">
                    <i class="bi bi-pencil-square me-2"></i> Editar Cita
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-light border mb-4">
                        <small class="text-muted text-uppercase fw-bold">Editando cita para:</small>
                        <h4 class="text-primary mb-0">{{ cita.paciente.nombre }} {{ cita.paciente.apellido }}</h4>
                    </div>

                    <form method="post" id="form-editar">
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Fecha</label>
                                {{ form.fecha }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Hora</label>
                                {{ form.hora }}
                                <div id="availability-status" class="form-text fw-bold mt-1"></div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Consultorio</label>
                                {{ form.consultorio }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Terapeuta</label>
                                {{ form.terapeuta }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">División</label>
                                {{ form.division }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Servicio</label>
                                {{ form.servicio }}
                            </div>

                            <div class="col-12">
                                <label class="form-label">Notas</label>
                                {{ form.notas }}
                            </div>
                            
                            <div class="col-md-4">
                                <label class="form-label">Estatus</label>
                                {{ form.estatus }}
                            </div>
                            
                            <div class="d-none">
                                {{ form.paciente }}
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="javascript:history.back()" class="btn btn-secondary">Cancelar</a>
                            <button type="submit" class="btn btn-primary fw-bold px-4">
                                <i class="bi bi-save me-2"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('#form-editar');
        const submitBtn = document.querySelector('button[type="submit"]');
        
        // Desactivar validación HTML5
        if (form) {
            form.noValidate = true;
            form.setAttribute('novalidate', 'novalidate');
        }
        
        // Remover required de TODOS los inputs
        document.querySelectorAll('input, select, textarea').forEach(field => {
            field.removeAttribute('required');
            field.classList.remove('is-invalid', 'is-valid');
        });
        
        // Botón siempre habilitado
        submitBtn.disabled = false;
        submitBtn.removeAttribute('disabled');
        
        // Limpiar errores visuales
        document.querySelectorAll('.errorlist, .invalid-feedback, .text-danger, .alert-danger, .is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
            el.style.display = 'none';
        });
        
        // Al cambiar campos, limpiar
        document.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('change', function() {
                this.removeAttribute('required');
                this.classList.remove('is-invalid', 'is-valid');
            });
            
            field.addEventListener('blur', function() {
                this.classList.remove('is-invalid');
            });
        });
        
        // No validar en submit
        form.addEventListener('submit', function(e) {
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.removeAttribute('required');
                field.classList.remove('is-invalid');
            });
            submitBtn.disabled = false;
            submitBtn.removeAttribute('disabled');
        });
        
        // Monitoreo cada 200ms para limpiar
        setInterval(function() {
            document.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.hasAttribute('required')) {
                    field.removeAttribute('required');
                }
                field.classList.remove('is-invalid');
            });
            submitBtn.disabled = false;
            submitBtn.removeAttribute('disabled');
        }, 200);
    });
</script>
{% endblock %}