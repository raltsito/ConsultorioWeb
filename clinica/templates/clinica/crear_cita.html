{% extends 'clinica/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<div class="container mt-4 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card shadow border-0 rounded-3">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: #0d6efd; border-top-left-radius: 0.3rem; border-top-right-radius: 0.3rem;">
                    <h5 class="mb-0 fw-semibold">Nueva Cita</h5>
                </div>
                
                <div class="card-body p-4 bg-white">
                    <form method="post" id="form-crear">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Paciente:</label>
                            {{ form.paciente }}
                            
                            <div id="caja-terapeutas" class="mt-2 d-none p-2 bg-light border rounded-3 border-info border-start border-4">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Fecha:</label>
                            {{ form.fecha }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Hora:</label>
                            {{ form.hora }}
                            <div id="availability-status" class="form-text mt-1"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">División:</label>
                            {{ form.division }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Consultorio:</label>
                            {{ form.consultorio }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Servicio:</label>
                            {{ form.servicio }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Terapeuta:</label>
                            {{ form.terapeuta }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Costo:</label>
                            {{ form.costo }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Método pago:</label>
                            {{ form.metodo_pago }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Estatus:</label>
                            {{ form.estatus }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Folio fiscal:</label>
                            {{ form.folio_fiscal }}
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted mb-1">Notas:</label>
                            {{ form.notas }}
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                            <a href="javascript:history.back()" class="btn btn-secondary px-4">Cerrar</a>
                            <button type="submit" class="btn btn-success px-4" id="btn-guardar" disabled>Agendar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const $fecha = $('#id_fecha');
        const $hora = $('#id_hora');
        const $consultorio = $('#id_consultorio');
        const $terapeuta = $('#id_terapeuta');
        const $status = $('#availability-status');
        const $btnGuardar = $('#btn-guardar');
$('#id_paciente').select2({
            placeholder: "Escribe el nombre del paciente...",
            allowClear: true,
            width: '100%',
            language: {
                noResults: function() {
                    return "No se encontraron pacientes";
                }
            }
        });
        // Función de validación silenciosa
        function checkAvailability() {
            const fecha = $fecha.val();
            const hora = $hora.val();
            const consultorio = $consultorio.val();
            const terapeuta = $terapeuta.val();

            if (fecha && hora && consultorio && terapeuta) {
                $status.html('<span class="text-muted small">Verificando disponibilidad...</span>');
                
                $.get('/api/verificar-disponibilidad/', {
                    'fecha': fecha,
                    'hora': hora,
                    'consultorio': consultorio,
                    'terapeuta': terapeuta
                }, function(data) {
                    if (data.available) {
                        $status.html('<span class="text-success fw-bold small">' + data.msg + '</span>');
                        $btnGuardar.prop('disabled', false);
                        
                        // Limpieza de errores de validación previos
                        $('.is-invalid').removeClass('is-invalid');
                        $('.errorlist').fadeOut('fast');
                    } else {
                        $status.html('<span class="text-danger fw-bold small">' + data.msg + '</span>');
                        $btnGuardar.prop('disabled', true);
                    }
                });
            } else {
                $status.html(''); 
                $btnGuardar.prop('disabled', true);
            }
        }

        // Limpiar estilos de error al modificar un campo
        $('input, select').on('change', function() {
            $(this).removeClass('is-invalid');
            $(this).siblings('.errorlist').fadeOut('fast');
        });

        // Escuchar cambios en los campos clave
        $fecha.on('change', checkAvailability);
        $hora.on('change', checkAvailability);
        $consultorio.on('change', checkAvailability);
        $terapeuta.on('change', checkAvailability);
        
        // Ejecutar validación al cargar la página si el calendario ya llenó los datos
        setTimeout(checkAvailability, 300);
        $('#id_paciente').on('change', function() {
            const pacienteId = $(this).val();
            const $cajaTerapeutas = $('#caja-terapeutas');
            
            if (pacienteId) {
                // Si hay paciente, preguntamos a la API
                $.get('/api/terapeutas-paciente/', { 'paciente_id': pacienteId }, function(data) {
                    if (data.terapeutas && data.terapeutas.length > 0) {
                        // Construimos las etiquetas (badges) para cada terapeuta
                        let badges = data.terapeutas.map(t => `<span class="badge bg-info text-dark me-1 border">${t}</span>`).join('');
                        
                        $cajaTerapeutas.html(`
                            <small class="text-muted d-block fw-bold mb-1">Atendido previamente por:</small>
                            ${badges}
                        `).removeClass('d-none');
                    } else {
                        // Es paciente nuevo
                        $cajaTerapeutas.html(`
                            <small class="text-muted fst-italic">Paciente de primera vez (sin historial de terapeutas).</small>
                        `).removeClass('d-none');
                    }
                });
            } else {
                // Si borran el campo, escondemos la cajita
                $cajaTerapeutas.addClass('d-none').html('');
            }
        });

        // IMPORTANTE: Disparar el evento de inmediato si el paciente ya viene seleccionado (ej. desde el expediente)
        if ($('#id_paciente').val()) {
            $('#id_paciente').trigger('change');
        }
    });
</script>
{% endblock %}